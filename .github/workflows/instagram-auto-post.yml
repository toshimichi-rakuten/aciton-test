name: Instagram Auto Post

on:
  schedule:
    # 4æ™‚é–“ã”ã¨ã«å®Ÿè¡Œï¼ˆ0:00, 4:00, 8:00, 12:00, 16:00, 20:00 UTCï¼‰
    - cron: "0 0,4,8,12,16,20 * * *"
  workflow_dispatch:  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½

jobs:
  post-to-instagram:
    runs-on: ubuntu-latest

    steps:
      - name: Wait random time (0-120 minutes)
        run: |
          # 0-7200ç§’ï¼ˆ0-120åˆ†ï¼‰ã®ãƒ©ãƒ³ãƒ€ãƒ ãªå¾…æ©Ÿæ™‚é–“ã‚’ç”Ÿæˆ
          WAIT_SECONDS=$((RANDOM % 7200))
          WAIT_MINUTES=$((WAIT_SECONDS / 60))
          echo "â³ ãƒ©ãƒ³ãƒ€ãƒ å¾…æ©Ÿæ™‚é–“: ${WAIT_MINUTES}åˆ† (${WAIT_SECONDS}ç§’)"
          echo "ç¾åœ¨æ™‚åˆ»: $(date)"
          sleep $WAIT_SECONDS
          echo "å¾…æ©Ÿçµ‚äº†: $(date)"

      - name: Call Dify Workflow API
        env:
          DIFY_API_KEY: ${{ secrets.DIFY_API_KEY }}
        run: |
          echo "ğŸš€ Dify ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’å®Ÿè¡Œä¸­ï¼ˆã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ãƒ¢ãƒ¼ãƒ‰ï¼‰..."

          # ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ãƒ¢ãƒ¼ãƒ‰ã§Dify APIã‚’å‘¼ã³å‡ºã—
          curl -N -X POST 'https://rakuten.dify.scorobo.ai/v1/workflows/run' \
            --header "Authorization: Bearer ${DIFY_API_KEY}" \
            --header 'Content-Type: application/json' \
            --data-raw '{
              "inputs": {
                "prompt": "çµ¶æ™¯ã®ä¸­ã«ã„ã‚‹å¯æ„›ã„å‹•ç‰©"
              },
              "response_mode": "streaming",
              "user": "github-actions-bot"
            }' > /tmp/dify_stream.txt 2>&1

          # ã‚¹ãƒˆãƒªãƒ¼ãƒ ã®å†…å®¹ã‚’è¡¨ç¤º
          echo "ğŸ“¡ ã‚¹ãƒˆãƒªãƒ¼ãƒ ãƒ¬ã‚¹ãƒãƒ³ã‚¹:"
          cat /tmp/dify_stream.txt
          echo ""

          # workflow_finishedã‚¤ãƒ™ãƒ³ãƒˆã‚’æ¢ã™
          if grep -q "event: workflow_finished" /tmp/dify_stream.txt; then
            echo "âœ… ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Œäº†ã‚¤ãƒ™ãƒ³ãƒˆã‚’æ¤œå‡º"

            # æœ€å¾Œã®workflow_finishedã‚¤ãƒ™ãƒ³ãƒˆã®ãƒ‡ãƒ¼ã‚¿ã‚’æŠ½å‡º
            FINISHED_DATA=$(grep -A 1 "event: workflow_finished" /tmp/dify_stream.txt | grep "^data:" | tail -n 1 | sed 's/^data: //')

            # ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ãƒã‚§ãƒƒã‚¯
            STATUS=$(echo "$FINISHED_DATA" | python3 -c "import sys, json; print(json.load(sys.stdin)['data']['status'])" 2>/dev/null || echo "unknown")

            if [ "$STATUS" = "succeeded" ]; then
              echo "âœ… InstagramæŠ•ç¨¿æˆåŠŸï¼"
              exit 0
            else
              echo "âš ï¸ ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¯å®Ÿè¡Œã•ã‚Œã¾ã—ãŸãŒã€ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: $STATUS"
              ERROR=$(echo "$FINISHED_DATA" | python3 -c "import sys, json; print(json.load(sys.stdin)['data'].get('error', 'No error message'))" 2>/dev/null || echo "unknown")
              echo "ã‚¨ãƒ©ãƒ¼: $ERROR"
              exit 1
            fi
          else
            echo "âŒ workflow_finishedã‚¤ãƒ™ãƒ³ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            echo "ã‚¹ãƒˆãƒªãƒ¼ãƒ å†…å®¹ã‚’ç¢ºèªã—ã¦ãã ã•ã„"
            exit 1
          fi

      - name: Notify on failure
        if: failure()
        run: |
          echo "âŒ Instagramè‡ªå‹•æŠ•ç¨¿ã«å¤±æ•—ã—ã¾ã—ãŸ"
          echo "ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—: $(date)"
