name: Instagram Auto Post

on:
  schedule:
    # 4時間ごとに実行（0:00, 4:00, 8:00, 12:00, 16:00, 20:00 UTC）
    - cron: "0 0,4,8,12,16,20 * * *"
  workflow_dispatch:  # 手動実行も可能

jobs:
  post-to-instagram:
    runs-on: ubuntu-latest

    steps:
      - name: Wait random time (0-120 minutes)
        run: |
          # 0-7200秒（0-120分）のランダムな待機時間を生成
          WAIT_SECONDS=$((RANDOM % 10))
          WAIT_MINUTES=$((WAIT_SECONDS / 60))
          echo "⏳ ランダム待機時間: ${WAIT_MINUTES}分 (${WAIT_SECONDS}秒)"
          echo "現在時刻: $(date)"
          sleep $WAIT_SECONDS
          echo "待機終了: $(date)"

      - name: Call Dify Workflow API
        env:
          DIFY_API_KEY: ${{ secrets.DIFY_API_KEY }}
        run: |
          echo "🚀 Dify ワークフローを実行中（ブロッキングモード）..."
          echo "開始時刻: $(date)"

          # Dify APIを呼び出し（ブロッキングモード、タイムアウト120秒）
          RESPONSE=$(curl -s -X POST 'https://rakuten.dify.scorobo.ai/v1/workflows/run' \
            --header "Authorization: Bearer ${DIFY_API_KEY}" \
            --header 'Content-Type: application/json' \
            --max-time 120 \
            --connect-timeout 30 \
            --retry 2 \
            --retry-delay 5 \
            --data-raw '{
              "inputs": {
                "prompt": "絶景の中にいる可愛い動物。超リアルで高画質の画像"
              },
              "response_mode": "blocking",
              "user": "github-actions-bot"
            }' 2>&1)

          CURL_EXIT=$?
          echo "終了時刻: $(date)"
          echo "curl exit code: $CURL_EXIT"
          echo ""

          # curlのexit codeをチェック
          if [ $CURL_EXIT -ne 0 ]; then
            echo "❌ curl実行エラー（exit code: $CURL_EXIT）"
            if [ $CURL_EXIT -eq 28 ]; then
              echo "タイムアウトエラー: Dify APIが120秒以内に応答しませんでした"
            elif [ $CURL_EXIT -eq 7 ]; then
              echo "接続エラー: Dify APIサーバーに接続できませんでした"
            fi
            echo ""
            echo "レスポンス内容:"
            echo "$RESPONSE"
            exit 1
          fi

          echo "📡 Dify APIレスポンス:"
          echo "$RESPONSE"
          echo ""

          # レスポンスが空でないかチェック
          if [ -z "$RESPONSE" ]; then
            echo "❌ レスポンスが空です"
            exit 1
          fi

          # エラーレスポンスかチェック
          if echo "$RESPONSE" | grep -q '"code".*:'; then
            ERROR_MSG=$(echo "$RESPONSE" | python3 -c "import sys, json; data=json.load(sys.stdin); print(data.get('message', 'Unknown error'))" 2>/dev/null || echo "API Error")
            echo "❌ Dify APIエラー: $ERROR_MSG"
            exit 1
          fi

          # ステータスをチェック
          STATUS=$(echo "$RESPONSE" | python3 -c "import sys, json; data=json.load(sys.stdin); print(data.get('data', {}).get('status', 'unknown'))" 2>/dev/null || echo "unknown")

          echo "ワークフローステータス: $STATUS"

          if [ "$STATUS" = "succeeded" ]; then
            POST_ID=$(echo "$RESPONSE" | python3 -c "import sys, json; data=json.load(sys.stdin); print(data.get('data', {}).get('outputs', {}).get('post_id', 'N/A'))" 2>/dev/null || echo "N/A")
            ELAPSED=$(echo "$RESPONSE" | python3 -c "import sys, json; data=json.load(sys.stdin); print(data.get('data', {}).get('elapsed_time', 'N/A'))" 2>/dev/null || echo "N/A")
            echo "✅ Instagram投稿成功！"
            echo "Post ID: $POST_ID"
            echo "実行時間: ${ELAPSED}秒"
            exit 0
          elif [ "$STATUS" = "failed" ]; then
            ERROR=$(echo "$RESPONSE" | python3 -c "import sys, json; data=json.load(sys.stdin); print(data.get('data', {}).get('error', 'No error message'))" 2>/dev/null || echo "unknown")
            echo "❌ ワークフロー失敗: $ERROR"
            exit 1
          else
            echo "⚠️ 不明なステータス: $STATUS"
            echo "JSONパース失敗の可能性があります"
            exit 1
          fi

      - name: Notify on failure
        if: failure()
        run: |
          echo "❌ Instagram自動投稿に失敗しました"
          echo "タイムスタンプ: $(date)"
