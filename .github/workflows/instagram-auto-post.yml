name: Instagram Auto Post (Streaming)

on:
  schedule:
    # 4æ™‚é–“ã”ã¨ã«å®Ÿè¡Œï¼ˆ0:00, 4:00, 8:00, 12:00, 16:00, 20:00 UTCï¼‰
    - cron: "0 0,4,8,12,16,20 * * *"
  workflow_dispatch:  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½

jobs:
  post-to-instagram:
    runs-on: ubuntu-latest
    timeout-minutes: 15  # ã‚¸ãƒ§ãƒ–å…¨ä½“ã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’15åˆ†ã«è¨­å®š

    steps:
      - name: Wait random time (0-10 seconds)
        run: |
          # 0-10ç§’ã®ãƒ©ãƒ³ãƒ€ãƒ ãªå¾…æ©Ÿæ™‚é–“ã‚’ç”Ÿæˆ
          WAIT_SECONDS=$((RANDOM % 10))
          echo "â³ ãƒ©ãƒ³ãƒ€ãƒ å¾…æ©Ÿæ™‚é–“: ${WAIT_SECONDS}ç§’"
          echo "ç¾åœ¨æ™‚åˆ»: $(date)"
          sleep $WAIT_SECONDS
          echo "å¾…æ©Ÿçµ‚äº†: $(date)"

      - name: Call Dify Workflow API (Streaming Mode)
        env:
          DIFY_API_KEY: ${{ secrets.DIFY_API_KEY }}
        run: |
          echo "ğŸš€ Dify ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’å®Ÿè¡Œä¸­ï¼ˆã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ãƒ¢ãƒ¼ãƒ‰ï¼‰..."
          echo "é–‹å§‹æ™‚åˆ»: $(date)"

          # ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ãƒ¢ãƒ¼ãƒ‰ã§å®Ÿè¡Œã—ã€é€”ä¸­çµŒéã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è¡¨ç¤º
          curl -N -X POST 'https://rakuten.dify.scorobo.ai/v1/workflows/run' \
            --header "Authorization: Bearer ${DIFY_API_KEY}" \
            --header 'Content-Type: application/json' \
            --max-time 600 \
            --connect-timeout 30 \
            --data-raw '{
              "inputs": {
                "prompt": "çµ¶æ™¯ã®ä¸­ã«ã„ã‚‹å¯æ„›ã„å‹•ç‰©ã€‚è¶…ãƒªã‚¢ãƒ«ã§é«˜ç”»è³ªã®ç”»åƒ"
              },
              "response_mode": "streaming",
              "user": "github-actions-bot"
            }' 2>&1 | tee /tmp/dify_stream_full.txt | while IFS= read -r line; do

            # node_startedã‚¤ãƒ™ãƒ³ãƒˆã‚’æ¤œå‡º
            if echo "$line" | grep -q '"event":"node_started"'; then
              NODE_TITLE=$(echo "$line" | python3 -c "import sys, json; data=json.loads(sys.stdin.read().split('data: ')[1]); print(data.get('data', {}).get('title', 'Unknown'))" 2>/dev/null || echo "Unknown")
              NODE_TYPE=$(echo "$line" | python3 -c "import sys, json; data=json.loads(sys.stdin.read().split('data: ')[1]); print(data.get('data', {}).get('node_type', 'Unknown'))" 2>/dev/null || echo "Unknown")
              echo "â–¶ï¸  ãƒãƒ¼ãƒ‰é–‹å§‹: $NODE_TITLE ($NODE_TYPE)"
            fi

            # node_finishedã‚¤ãƒ™ãƒ³ãƒˆã‚’æ¤œå‡º
            if echo "$line" | grep -q '"event":"node_finished"'; then
              NODE_TITLE=$(echo "$line" | python3 -c "import sys, json; data=json.loads(sys.stdin.read().split('data: ')[1]); print(data.get('data', {}).get('title', 'Unknown'))" 2>/dev/null || echo "Unknown")
              STATUS=$(echo "$line" | python3 -c "import sys, json; data=json.loads(sys.stdin.read().split('data: ')[1]); print(data.get('data', {}).get('status', 'Unknown'))" 2>/dev/null || echo "Unknown")
              ELAPSED=$(echo "$line" | python3 -c "import sys, json; data=json.loads(sys.stdin.read().split('data: ')[1]); print(data.get('data', {}).get('elapsed_time', 'N/A'))" 2>/dev/null || echo "N/A")

              if [ "$STATUS" = "succeeded" ]; then
                echo "âœ… ãƒãƒ¼ãƒ‰å®Œäº†: $NODE_TITLE (${ELAPSED}ç§’)"
              else
                echo "âŒ ãƒãƒ¼ãƒ‰å¤±æ•—: $NODE_TITLE (status: $STATUS)"
              fi
            fi

            # workflow_finishedã‚¤ãƒ™ãƒ³ãƒˆã‚’æ¤œå‡º
            if echo "$line" | grep -q '"event":"workflow_finished"'; then
              echo ""
              echo "ğŸ ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼çµ‚äº†ã‚¤ãƒ™ãƒ³ãƒˆã‚’æ¤œå‡º"
            fi
          done

          echo ""
          echo "çµ‚äº†æ™‚åˆ»: $(date)"

          # æœ€çµ‚çµæœã‚’ç¢ºèª
          if grep -q '"event":"workflow_finished"' /tmp/dify_stream_full.txt; then
            FINAL_DATA=$(grep -A 1 '"event":"workflow_finished"' /tmp/dify_stream_full.txt | grep '^data:' | tail -n 1 | sed 's/^data: //')
            FINAL_STATUS=$(echo "$FINAL_DATA" | python3 -c "import sys, json; print(json.load(sys.stdin)['data']['status'])" 2>/dev/null || echo "unknown")

            if [ "$FINAL_STATUS" = "succeeded" ]; then
              POST_ID=$(echo "$FINAL_DATA" | python3 -c "import sys, json; print(json.load(sys.stdin)['data'].get('outputs', {}).get('post_id', 'N/A'))" 2>/dev/null || echo "N/A")
              echo "âœ… InstagramæŠ•ç¨¿æˆåŠŸï¼"
              echo "Post ID: $POST_ID"
              exit 0
            else
              ERROR=$(echo "$FINAL_DATA" | python3 -c "import sys, json; print(json.load(sys.stdin)['data'].get('error', 'No error message'))" 2>/dev/null || echo "unknown")
              echo "âŒ ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å¤±æ•—: $ERROR"
              exit 1
            fi
          else
            echo "âŒ workflow_finishedã‚¤ãƒ™ãƒ³ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            echo "ã‚¹ãƒˆãƒªãƒ¼ãƒ ã®æœ€å¾Œã®20è¡Œ:"
            tail -20 /tmp/dify_stream_full.txt
            exit 1
          fi

      - name: Notify on failure
        if: failure()
        run: |
          echo "âŒ Instagramè‡ªå‹•æŠ•ç¨¿ã«å¤±æ•—ã—ã¾ã—ãŸ"
          echo "ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—: $(date)"
