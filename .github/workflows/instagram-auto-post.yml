name: Instagram Auto Post

on:
  schedule:
    # 4æ™‚é–“ã”ã¨ã«å®Ÿè¡Œï¼ˆ0:00, 4:00, 8:00, 12:00, 16:00, 20:00 UTCï¼‰
    - cron: "0 0,4,8,12,16,20 * * *"
  workflow_dispatch:  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½

jobs:
  post-to-instagram:
    runs-on: ubuntu-latest

    steps:
      - name: Wait random time (0-120 minutes)
        run: |
          # 0-7200ç§’ï¼ˆ0-120åˆ†ï¼‰ã®ãƒ©ãƒ³ãƒ€ãƒ ãªå¾…æ©Ÿæ™‚é–“ã‚’ç”Ÿæˆ
          WAIT_SECONDS=$((RANDOM % 7200))
          WAIT_MINUTES=$((WAIT_SECONDS / 60))
          echo "â³ ãƒ©ãƒ³ãƒ€ãƒ å¾…æ©Ÿæ™‚é–“: ${WAIT_MINUTES}åˆ† (${WAIT_SECONDS}ç§’)"
          echo "ç¾åœ¨æ™‚åˆ»: $(date)"
          sleep $WAIT_SECONDS
          echo "å¾…æ©Ÿçµ‚äº†: $(date)"

      - name: Call Dify Workflow API
        env:
          DIFY_API_KEY: ${{ secrets.DIFY_API_KEY }}
        run: |
          echo "ğŸš€ Dify ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’å®Ÿè¡Œä¸­..."

          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST 'https://rakuten.dify.scorobo.ai/v1/workflows/run' \
            --header "Authorization: Bearer ${DIFY_API_KEY}" \
            --header 'Content-Type: application/json' \
            --data-raw '{
              "inputs": {
                "prompt": "å‹•ç‰©ã®å¯æ„›ã„ç”»åƒã‚’ç”Ÿæˆã—ã¦Instagramã«æŠ•ç¨¿ã—ã¦ãã ã•ã„"
              },
              "response_mode": "blocking",
              "user": "github-actions-bot"
            }')

          # HTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’å–å¾—
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | head -n-1)

          echo "HTTP Status: $HTTP_CODE"
          echo "Response: $BODY"

          # ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆè¡¨ç¤º
          echo "$BODY" | python3 -m json.tool || echo "$BODY"

          # ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒã‚§ãƒƒã‚¯
          if [ "$HTTP_CODE" -eq 200 ]; then
            STATUS=$(echo "$BODY" | python3 -c "import sys, json; print(json.load(sys.stdin)['data']['status'])" 2>/dev/null || echo "unknown")

            if [ "$STATUS" = "succeeded" ]; then
              echo "âœ… InstagramæŠ•ç¨¿æˆåŠŸï¼"
              exit 0
            else
              echo "âš ï¸ ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¯å®Ÿè¡Œã•ã‚Œã¾ã—ãŸãŒã€ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: $STATUS"
              ERROR=$(echo "$BODY" | python3 -c "import sys, json; print(json.load(sys.stdin)['data'].get('error', 'No error message'))" 2>/dev/null || echo "unknown")
              echo "ã‚¨ãƒ©ãƒ¼: $ERROR"
              exit 1
            fi
          else
            echo "âŒ APIå‘¼ã³å‡ºã—ã«å¤±æ•—ã—ã¾ã—ãŸ"
            exit 1
          fi

      - name: Notify on failure
        if: failure()
        run: |
          echo "âŒ Instagramè‡ªå‹•æŠ•ç¨¿ã«å¤±æ•—ã—ã¾ã—ãŸ"
          echo "ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—: $(date)"
