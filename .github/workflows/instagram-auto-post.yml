name: Instagram Auto Post

on:
  schedule:
    # 4時間ごとに実行（0:00, 4:00, 8:00, 12:00, 16:00, 20:00 UTC）
    - cron: "0 0,4,8,12,16,20 * * *"
  workflow_dispatch:  # 手動実行も可能

jobs:
  post-to-instagram:
    runs-on: ubuntu-latest

    steps:
      - name: Wait random time (0-120 minutes)
        run: |
          # 0-7200秒（0-120分）のランダムな待機時間を生成
          WAIT_SECONDS=$((RANDOM % 10))
          WAIT_MINUTES=$((WAIT_SECONDS / 60))
          echo "⏳ ランダム待機時間: ${WAIT_MINUTES}分 (${WAIT_SECONDS}秒)"
          echo "現在時刻: $(date)"
          sleep $WAIT_SECONDS
          echo "待機終了: $(date)"

      - name: Call Dify Workflow API
        env:
          DIFY_API_KEY: ${{ secrets.DIFY_API_KEY }}
        run: |
          echo "🚀 Dify ワークフローを実行中（ストリーミングモード）..."
          echo "開始時刻: $(date)"

          # ストリーミングモードでDify APIを呼び出し（タイムアウト10分）
          # -v オプションで詳細なデバッグ情報を出力
          timeout 600 curl -v -N -X POST 'https://rakuten.dify.scorobo.ai/v1/workflows/run' \
            --header "Authorization: Bearer ${DIFY_API_KEY}" \
            --header 'Content-Type: application/json' \
            --max-time 600 \
            --connect-timeout 30 \
            --keepalive-time 60 \
            --data-raw '{
              "inputs": {
                "prompt": "絶景の中にいる可愛い動物。超リアルで高画質の画像"
              },
              "response_mode": "streaming",
              "user": "github-actions-bot"
            }' > /tmp/dify_stream.txt 2>&1

          CURL_EXIT=$?
          echo "終了時刻: $(date)"
          echo "curl exit code: $CURL_EXIT"

          # curlのexit codeを確認
          if [ $CURL_EXIT -eq 28 ]; then
            echo "❌ タイムアウトエラー（exit code 28）"
            echo "ストリームが600秒以内に完了しませんでした"
            exit 1
          elif [ $CURL_EXIT -eq 124 ]; then
            echo "❌ timeoutコマンドによる強制終了"
            exit 1
          elif [ $CURL_EXIT -ne 0 ]; then
            echo "❌ curlエラー（exit code: $CURL_EXIT）"
            exit 1
          fi

          # ストリームの内容を表示（最初の1000行のみ）
          echo "📡 ストリームレスポンス（先頭1000行）:"
          head -1000 /tmp/dify_stream.txt
          echo ""

          # ファイルサイズと行数を確認
          FILE_SIZE=$(wc -c < /tmp/dify_stream.txt)
          LINE_COUNT=$(wc -l < /tmp/dify_stream.txt)
          echo "ファイルサイズ: ${FILE_SIZE} bytes, 行数: ${LINE_COUNT}"

          # workflow_finishedイベントを探す
          if grep -q "event: workflow_finished" /tmp/dify_stream.txt; then
            echo "✅ ワークフロー完了イベントを検出"

            # 最後のworkflow_finishedイベントのデータを抽出
            FINISHED_DATA=$(grep -A 1 "event: workflow_finished" /tmp/dify_stream.txt | grep "^data:" | tail -n 1 | sed 's/^data: //')

            # ステータスをチェック
            STATUS=$(echo "$FINISHED_DATA" | python3 -c "import sys, json; print(json.load(sys.stdin)['data']['status'])" 2>/dev/null || echo "unknown")

            if [ "$STATUS" = "succeeded" ]; then
              echo "✅ Instagram投稿成功！"
              exit 0
            else
              echo "⚠️ ワークフローは実行されましたが、ステータス: $STATUS"
              ERROR=$(echo "$FINISHED_DATA" | python3 -c "import sys, json; print(json.load(sys.stdin)['data'].get('error', 'No error message'))" 2>/dev/null || echo "unknown")
              echo "エラー: $ERROR"
              exit 1
            fi
          else
            echo "❌ workflow_finishedイベントが見つかりません"
            echo "ストリーム内容の最後の50行:"
            tail -50 /tmp/dify_stream.txt
            exit 1
          fi

      - name: Notify on failure
        if: failure()
        run: |
          echo "❌ Instagram自動投稿に失敗しました"
          echo "タイムスタンプ: $(date)"
